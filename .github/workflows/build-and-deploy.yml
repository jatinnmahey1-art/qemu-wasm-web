# .github/workflows/build-and-deploy.yml
name: Build QEMU â†’ WASM + Deploy

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.66
          actions-cache-folder: emsdk-cache

      - name: Cache QEMU
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            qemu/
            qemu-build/
          key: qemu-wasm-v5-${{ hashFiles('patches/0001-emscripten-fixes.patch') }}
          restore-keys: qemu-wasm-v5-

      - name: Clone QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://gitlab.com/qemu-project/qemu.git

      - name: Fix patch line endings
        run: |
          find patches -name "*.patch" -exec sed -i 's/\r$//' {} \;

      - name: Apply patch
        run: |
          cd qemu
          echo "=== Applying patch ==="
          git apply --verbose --whitespace=fix ../patches/0001-emscripten-fixes.patch || {
            echo "PATCH FAILED"
            exit 1
          }

      - name: Build QEMU
        run: |
          source $EMSDK/emsdk_env.sh
          mkdir -p qemu-build && cd qemu-build
          
          ../qemu/configure \
            --target-list=riscv64-softmmu \
            --disable-system \
            --disable-user \
            --disable-pie \
            --extra-cflags="-s USE_PTHREADS=1 -O3" \
            --extra-ldflags="-s ASYNCIFY=1 -s PTHREAD_POOL_SIZE=8 -s ASYNCIFY_STACK_SIZE=256KB"

          emmake make -j$(nproc) qemu-system-riscv64

      - name: Package Web
        run: |
          source $EMSDK/emsdk_env.sh
          mkdir -p web/preload
          cp web/assets/alpine.img web/assets/bios/* web/preload/

          emcc qemu-build/riscv64-softmmu/qemu-system-riscv64 \
            -o web/qemu-system-riscv64.html \
            --preload-file web/preload@/ \
            -s FORCE_FILESYSTEM=1 \
            -s EXIT_RUNTIME=1 \
            -s ASYNCIFY=1 \
            -s USE_PTHREADS=1 \
            -s PTHREAD_POOL_SIZE=8 \
            -s INITIAL_MEMORY=512MB \
            -O3

          rm -rf web/preload

      - name: Upload Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: web/

      - name: Deploy
        uses: actions/deploy-pages@v4
