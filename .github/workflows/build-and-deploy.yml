# .github/workflows/build-and-deploy.yml
name: Build QEMU → WASM + Deploy

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.66   # latest working
          actions-cache-folder: emsdk-cache

      - name: Cache QEMU
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            qemu/
            qemu-build/
          key: qemu-wasm-${{ hashFiles('patches/0001-emscripten-fixes.patch') }}-${{ runner.os }}
          restore-keys: qemu-wasm-

      - name: Clone QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://gitlab.com/qemu-project/qemu.git

      - name: Apply patches (100% reliable)
        run: |
          find patches -name "*.patch" -exec sed -i 's/\r$//' {} \;
          cd qemu
          echo "=== Applying Emscripten patch ==="
          git apply --reject --whitespace=fix --verbose ../patches/0001-emscripten-fixes.patch || exit 1

      - name: Build QEMU → WASM
        run: |
          source $EMSDK/emsdk_env.sh
          mkdir -p qemu-build && cd qemu-build
          
          ../qemu/configure \
            --target-list=riscv64-softmmu \
            --disable-system --disable-user --disable-pie \
            --extra-cflags="-s USE_PTHREADS -s PTHREAD_POOL_SIZE=8 -O3" \
            --extra-ldflags="-s ASYNCIFY=1 -s ASYNCIFY_STACK_SIZE=256KB -s EXIT_RUNTIME=1"

          emmake make -j$(nproc) qemu-system-riscv64

      - name: Package Web Demo
        run: |
          source $EMSDK/emsdk_env.sh
          
          mkdir -p web/preload
          cp web/assets/alpine.img web/assets/bios/* web/preload/

          emcc qemu-build/riscv64-softmmu/qemu-system-riscv64 \
            -o web/qemu-system-riscv64.html \
            --preload-file web/preload@/ \
            -s FORCE_FILESYSTEM=1 \
            -s EXIT_RUNTIME=1 \
            -s ASYNCIFY=1 \
            -s USE_PTHREADS=1 \
            -s PTHREAD_POOL_SIZE=8 \
            -s INITIAL_MEMORY=512MB \
            -s ASYNCIFY_STACK_SIZE=256KB \
            -O3

          rm -rf web/preload

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: web/

      - name: Deploy
        uses: actions/deploy-pages@v4
