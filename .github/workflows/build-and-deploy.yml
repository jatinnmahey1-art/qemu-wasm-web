name: Build QEMU â†’ WASM + Deploy

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51
          actions-cache-folder: emsdk-cache

      - name: Cache QEMU
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            qemu/
            qemu-build/
          key: qemu-wasm-v4-${{ hashFiles('patches/*.patch') }}
          restore-keys: qemu-wasm-v4-

      - name: Clone QEMU
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v9.1.0 https://gitlab.com/qemu-project/qemu.git

      - name: Apply patches (fuzzy, safe)
        run: |
          find patches -name "*.patch" -exec sed -i 's/\r$//' {} \;
          cd qemu
          for p in ../patches/*.patch; do
            echo "=== Applying $p ==="
            git apply --verbose --ignore-space-change --ignore-whitespace --whitespace=nowarn "$p" || exit 1
          done

      - name: Build QEMU WASM
        run: |
          source $EMSDK/emsdk_env.sh
          mkdir -p qemu-build && cd qemu-build
          
          ../qemu/configure \
            --target-list=riscv64-softmmu \
            --disable-system --disable-user --disable-pie \
            --extra-cflags="-s USE_PTHREADS=1 -O3" \
            --extra-ldflags="-s ASYNCIFY=1 -s PTHREAD_POOL_SIZE=8 -s ASYNCIFY_STACK_SIZE=262144"

          emmake make -j$(nproc) qemu-system-riscv64

      - name: Package Web Assets
        run: |
          source $EMSDK/emsdk_env.sh
          mkdir -p web/preload
          cp web/assets/alpine.img web/assets/bios/* web/preload/

          emcc qemu-build/riscv64-softmmu/qemu-system-riscv64 \
            -o web/qemu-system-riscv64.html \
            --preload-file web/preload@/ \
            -s FORCE_FILESYSTEM=1 \
            -s EXIT_RUNTIME=1 \
            -s ASYNCIFY=1 \
            -s USE_PTHREADS=1 \
            -s PTHREAD_POOL_SIZE=8 \
            -s INITIAL_MEMORY=512MB \
            -O3

          rm -rf web/preload

      - name: Upload Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: web/

      - name: Deploy
        uses: actions/deploy-pages@v4
